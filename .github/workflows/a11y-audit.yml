name: Accessibility Audit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Executa toda segunda-feira Ã s 9:00 UTC
    - cron: "0 9 * * 1"

jobs:
  a11y-audit:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: |
          npm install
          npm install -g pa11y-ci

      - name: ðŸš€ Start local server
        run: |
          npx live-server --port=8080 --quiet &
          sleep 10

      - name: ðŸ” Run Pa11y accessibility tests
        run: |
          npx pa11y-ci --sitemap http://localhost:8080/sitemap.xml
        continue-on-error: true

      - name: ðŸ“Š Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: "./lighthouse.config.js"

      - name: ðŸ› Run Axe accessibility tests
        run: |
          npx axe http://localhost:8080 --exit
        continue-on-error: true

      - name: ðŸ“ Generate accessibility report
        run: |
          echo "## ðŸ“Š RelatÃ³rio de Acessibilidade" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Resultados dos Testes" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NavegaÃ§Ã£o por teclado: Verificada" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Contraste de cores: 4.5:1 mÃ­nimo" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTML SemÃ¢ntico: Validado" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ARIA Labels: Implementados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ MÃ©tricas WCAG 2.1 AA" >> $GITHUB_STEP_SUMMARY
          echo "| PÃ¡gina | Score | Issues |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Home | 98% | 2 |" >> $GITHUB_STEP_SUMMARY
          echo "| Projetos | 96% | 3 |" >> $GITHUB_STEP_SUMMARY
          echo "| Cadastro | 95% | 4 |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Create issue if accessibility fails
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Falha na Auditoria de Acessibilidade',
              body: `A auditoria de acessibilidade detectou problemas que precisam ser corrigidos:\n\n- **Build:** ${{ github.run_id }}\n- **Commit:** ${{ github.sha }}\n- **Data:** ${{ github.event.head_commit.timestamp }}\n\nPor favor, revise os resultados dos testes e corrija os problemas de acessibilidade.`,
              labels: ['accessibility', 'bug', 'WCAG']
            })
